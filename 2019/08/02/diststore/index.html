<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="说说自己大数据接触的ES/HBase/TSDB/Redis/Celler"><meta name="keywords" content><meta name="author" content="zhuyuping"><meta name="copyright" content="zhuyuping"><title>说说自己大数据接触的ES/HBase/TSDB/Redis/Celler | 朱遇平的github博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.0"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">zhuyuping</div><div class="author-info__description text-center">掌握java相关知识，擅长大数据，以及机器学习算法应用方面 java scala python</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">20</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">朱遇平的github博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">说说自己大数据接触的ES/HBase/TSDB/Redis/Celler</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-08-02</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>因为以前个人工作平台架构工作主要负责中间件与大数据层，很多存储比如ES 比如 Hbase 比如 TSDB 比如 Celler，其实还有data hive alluxio但是这些其实这是数据组织结构的变化，或者相关引擎，相关大数据内存加速技术，其实接触多了，了解其实现久了你就会发现其实他们设计思想原理都很相似或许一些特性的不同决定了他们的作用。</p>
<p> 从设计上来说 他们都有一个协调者负责进行schema metadata信息的维护管理，通过一致性算法或者zk或者db方式或者复制机制、quarum机制来实现多副本一致性以及存储的分片副本容灾以及路由数据获取，他们都有通用的套路WAL+log机制 快照副本，他们都有尝试着zerocopy DMA机制以及pageCache来加快存储，他们有LRU 或者boolmfilter来过滤一些无效请求或者key,其实这些都是为了更大吞吐量更快速度，分布式互斥资源并发考虑，比如还有一些租约lease机制，比如还有一些quarum NWR机制，比如还有一些MVCC机制，还有就是副本的一致性考虑的，也就是CAP基础上尽可能保证高速度高吞吐量。剩余的就是怎么索引，至于常用的索引技术，有Hash索引 k/v,有倒排，有b/b+ 有LSM结构,有LSH bitSet 等等，这些思想套路其实在很多数据库上都类似。就像分布式事务套路：TCC 2PC 补偿对账 去重重发表就那么几种一样。分库分表套路：索引表，复写避免读，先hash在range ,hash合并hash，分表索引计数等等几种套路。明白了这些思想这些套路为什么这么做，为什么只能这么做就可以了解的，其实分布式存储也是一样，所以ES/HBase/TSDB/Redis/Celler 一些思想手段都是一样的。后来有一类新数据newSQL为了支持事务，不仅仅结合了mysql的ARIES算法，也才去了逻辑时钟全定序思想排序事务id,结合mvcc 2pc来实现事务功能，大体来说这是我做大数据基础架构接触到所认识到的东西。<br> 下面分别逐一讲一下，行列数据库区别不讲了，网上很多，其实这不是重要的。<br> <strong>下面介绍ES：</strong><br> ES 来说其实最主要的是倒排索引，当我们说<br> 正常的K==&gt;V 是文章XX =》 文章内容时候， 倒排是对V进行分词提取 分别建立V1 ==&gt; K V2=&gt;K V3=&gt;K,这样可以通过部分关键字V1 进行搜索匹配。这部分es是通过lucene进行的，关键在于他不仅仅记录了这样的key 还会记录字符位置关键字位置，以及频率得分，这样可以进行排序以及快速定位位置。另外还有一些压缩技术，这些使用pageCache大大加快了速度。所以es设置内存大小时候应该合理设置。<br> <strong>下面介绍Hbase:</strong></p>
<p> Hbase 这些通过master维护region 通过zk维护hbase表metadata信息，通过wal+log进行追加MVCC多版本实现update del 后面进行小文件合并大文件合并从而实现适合HDFS的存储，以及移除一些不必要的版本数据。而memstore 以LSM树内存中维护这排序结构，不断的内存中合并成小HFile，每一个HFile其实是一个B+树结构，然后后台大合并<br> 最后合并成大的HFile存储在HDFS中，然后为了避免一些不必要的查询操作，建立了缓存boomfilter,其他的就是列式数据库，所以使用了rowKey划分一个个region，预分区，master管理这些region以及副本。大体就是这样的。</p>
<p> <strong>下面介绍TSDB:</strong> </p>
<p> 我在喜马拉雅进行Xdcs日志监控系统中使用了openTSDB 其实是搭建在我们hbase基础上的时间系列数据库，他的思想就是我上面说的套路也就是索引表，对于metries tagk tagv组合都使用一张索引表存储，同时给他们编号唯一的id组合，然后对于每个事件的记录，提取完整事件的时间戳，组合上面的索引表的id 形成唯一的rowkey 而剩下的时间段，比如1小时的3600s ，比如某个时间是该时间里面1800秒那么他会在列中以1800s作为列名进行存储。大体就是这样。后来我的项目为了方便使用我试着加上apache calite 添加SQL解析层方便tsdb使用。</p>
<p> <strong>下面介绍Redis Cellar:</strong></p>
<p> 我了解的redis其实并不多，因为他是C开发的，在使用中我们常用他实现分布式锁，redssion开源项目结合使用，使用lua脚本以及pipline setnx watch来实现事务解决并发问题。所有的数据都存放在内存中，通用有RDB AOF 也就是WAL+log机制，多副本一致性的复制方案，因为都是内存中的操作，速度很快，所以不需要多线程来进行提高CPU，多线程主要是用来IO写时候CPU释放来重复提高CPU利用率，同时带来了CPU切换的开销，所以redis单线程足够了，所以一般redis会部署多个独立进程，多进程单线程机制。比较复杂的有rehash机制，还有zset 我们一般用来做排行榜，或内存k,list用来存储前几千条记录的分页结构，还有bitset 有一些库实现bitmap redis实现实现去重计数。因为redis的key value都在内存中，那么其实内存限制了存放数据大小的，那么有没有只有key存放在内存中 value存放在本地磁盘索引里面的数据库呢。这样虽然延时可能差了一些，但是也能满足一些缓存要求。我接触的比较有名的就是tair 叫做cellar。其实还有很多这样的KV数据库。其实他们大体都是bitcask思想。<br> 这类数据库，Key全部存放到内存中，bitcask引擎 采取了类似0、1目录机制，对文件分片之后，分为active data file以及其他older data files,对于为此写都是相同的因为磁盘随机读写的原因，也是append机制，对于每一条记录类似于kafka记录，有自己的编码格式，比如CRC 时间戳 keysize valuesize key  value，而每次更新内存中keydir结构更新维护这每一个key对应的bitcask文件 file_id value_size value_pos记录着 bitcask哪一个文件哪一个位置，这样可以进行相应的读取，从内存中keydir读取key的value所在文件以及位置以及大小，就可以进行读取，因为append机制，所以后台会有相关的合并进程类似于hbase进行相应的合并以及生产相应的hint索引文件方便重启简历keydir。<br>后来一些更加高效的rockdb leveldb出现了<br>所以一些数据库变，在rockdb leveldb基础上使用paxso raft 算法内存中维护一致性的key信息，而进行分片副本这些机制后，最终存储相关交给节点上的rockdb leveldb来进行。统一结合一些LRU boolmfilter 在内存中常驻一些经常访问的热点数据。更有一些在这些基础上实现SQL解析层，比如apache calite SQL parser 进行SQL解析，转为相关操作方便进行相关查询，这就是MPP机制。</p>
<p>上面这些就是我基础架构大数据中间件相关工作使用的一些存储相关的认识。其实后来我发现其实这些思想其实一直没有变过，而跟重要的理解为什么这么做，必须这么做。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zhuyuping</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/08/02/diststore/">http://yoursite.com/2019/08/02/diststore/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/08/19/LSM树的反思/"><i class="fa fa-chevron-left">  </i><span>一些架构设计常接触的思想结构</span></a></div><div class="next-post pull-right"><a href="/2019/08/01/incense/"><span>分布式去中心化计算框架的思考</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By zhuyuping</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.0"></script><script src="/js/fancybox.js?version=1.6.0"></script><script src="/js/sidebar.js?version=1.6.0"></script><script src="/js/copy.js?version=1.6.0"></script><script src="/js/fireworks.js?version=1.6.0"></script><script src="/js/transition.js?version=1.6.0"></script><script src="/js/scroll.js?version=1.6.0"></script><script src="/js/head.js?version=1.6.0"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>